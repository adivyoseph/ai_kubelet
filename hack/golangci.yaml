# golangci-lint is used in Kubernetes with different configurations that
# enable an increasing amount of checks:
# - golangci.yaml is the most permissive configuration. All existing code
#   passed.
# - golangci-hints.yaml adds checks for code patterns where developer
#   and reviewer may decide whether findings should get addressed before
#   merging. Beware that the golangci-lint output includes also the
#   issues that must be fixed and doesn't indicate how severe each issue
#   is (https://gophers.slack.com/archives/CS0TBRKPC/p1685721815275349).
#
# All three flavors are generated from golangci.yaml.in with
# hack/update-golangci-lint-config.sh.

run:
  timeout: 30m

output:
  show-stats: false

version: "2"

formatters:
  exclusions:
    paths:
      - third_party

issues:
  max-issues-per-linter: 0
  max-same-issues: 0

linters:
  exclusions:
    paths:
      - third_party

    # Excluding configuration per-path, per-linter, per-text and per-source
    rules:
      - path: (.+)\.go$
        # staticcheck: Developers tend to write in C-style with an explicit 'break' in a 'switch', so it's ok to ignore
        text: ineffective break statement. Did you mean to break out of the outer loop

      # exclude ineffassign linter for generated files for conversion
      - path: conversion\.go
        linters:
          - ineffassign

      # SSA Extract calls are allowed in tests.
      - linters:
          - forbidigo
        text: should not be used because managedFields was removed
        path: _test.go$

      # Adding unversioned feature gates is allowed in tests
      - linters:
          - forbidigo
        text: should not use Add, use AddVersioned instead
        path: _test.go$

      # TODO(oscr) Remove these excluded directories and fix findings. Due to large amount of findings in different components
      # with different owners it's hard to fix everything in a single pr. This will therefore be done in multiple prs.
      - path: (pkg/volume/*|test/*|azure/*|pkg/cmd/wait*|request/bearertoken/*|metrics/*|filters/*)
        linters:
          - gocritic

      # The Kubernetes naming convention for conversion functions uses underscores
      # and intentionally deviates from normal Go conventions to make those function
      # names more readable. Same for SetDefaults_*.
      #
      # https://github.com/kubernetes/kubernetes/issues/117288#issuecomment-1507028627
      # https://github.com/kubernetes/kubernetes/issues/117288#issuecomment-1514201592
      - linters:
          - staticcheck
          - revive
        text: "(ST1003: should not use underscores in Go names; func (Convert_.*_To_.*|SetDefaults_)|exported: exported function (Convert|SetDefaults)_.* should be of the form)"

      # This check currently has some false positives (https://github.com/nunnatsa/ginkgolinter/issues/91).
      - linters:
          - ginkgolinter
        text: use a function call in (Eventually|Consistently)

      # Some of these seem legitimate, maybe better fix code (https://github.com/kubernetes/kubernetes/issues/130449).

      - linters:
          - govet
        text: "lostcancel|printf"

      - linters:
          - ginkgolinter
        text: "wrong error assertion. Consider using `gomega.(Eventually|Consistently)|wrong comparison assertion|wrong length assertion"

      - linters:
          - testifylint
        text: "encoded-compare|error-nil|formatter"

      - linters:
          - gocritic
        text: "append result not assigned to the same slice|put a space between `//` and comment text|sloppyLen|elseif|should rewrite switch statement to if statement|regexpMust|wrapperFunc: use strings.ReplaceAll|singleCaseSwitch|deprecatedComment|exitAfterDefer|captLocal|unlambda|underef|unslice|valSwap|typeSwitchVar"

      # https://github.com/kubernetes/kubernetes/issues/117288#issuecomment-1507012435
      - linters:
          - gocritic
        text: "ifElseChain: rewrite if-else to switch statement"

      # Only packages listed here opt into the strict "exported symbols must be documented".
      #
      # Exclude texts from https://github.com/golangci/golangci-lint/blob/ab3c3cd69e602ff53bb4c3e2c188f0caeb80305d/pkg/config/issues.go#L11-L103
      - linters:
          - revive
          - staticcheck
        text: comment on exported (method|function|type|const)|should have( a package)? comment|comment should be of the form|comment on exported (method|function|type|const)|should have( a package)? comment|comment should be of the form|exported (.+) should have comment( \(or a comment on this block\))? or be unexported|package comment should be of the form "(.+)...|comment on exported (.+) should be of the form "(.+)...|should have a package comment
        path-except: cmd/kubeadm

      # The unused linter that comes from staticcheck currently does not handle types which implement
      # a generic interface. The linter incorrectly reports the implementations of unexported
      # interface methods as unused. See https://github.com/dominikh/go-tools/issues/1294.
      # Rather than exporting the interface methods, which makes the error go away but changes the
      # semantics of the code, we ignore this error for affected files.
      # This can be removed when the staticcheck implementation of this rule is fixed, which may
      # depend on https://github.com/golang/go/issues/63982.
      - linters:
          - unused
        path: staging/src/k8s.io/client-go/util/workqueue/metrics.go

      # The following issues were deemed "might be worth fixing, needs to be
      # decided on a case-by-case basis".  This was initially decided by a
      # majority of the developers who voted in
      # https://github.com/kubernetes/kubernetes/issues/117288 and may evolve
      # over time.

      # https://github.com/kubernetes/kubernetes/issues/117288#issuecomment-1507008918
      - linters:
          - gocritic
        text: "assignOp:"

      # https://github.com/kubernetes/kubernetes/issues/117288#issuecomment-1507016854
      - linters:
          - staticcheck
        text: "S1002: should omit comparison to bool constant"

      # https://github.com/kubernetes/kubernetes/issues/117288#issuecomment-1507023980
      - linters:
          - staticcheck
        text: "S1016: should convert opts .* instead of using struct literal"

      # https://github.com/kubernetes/kubernetes/issues/117288#issuecomment-1507026758
      - linters:
          - staticcheck
        text: "S1033: unnecessary guard around call to delete"

      # Didn't make it into https://github.com/kubernetes/kubernetes/issues/117288.
      # Discussion on Slack concluded that "it's hard to have a universal policy for all
      # functions marked deprecated" and thus this can only be a hint which must
      # be considered on a case-by-case basis.
      - linters:
          - staticcheck
        text: "SA1019: .*is deprecated"

      # https://github.com/kubernetes/kubernetes/issues/117288#issuecomment-1507030071
      - linters:
          - staticcheck
        text: "ST1012: error var .* should have name of the form ErrFoo"

      # https://github.com/kubernetes/kubernetes/issues/117288#issuecomment-1507031224
      - linters:
          - staticcheck
        text: "ST1023: should omit type .* from declaration; it will be inferred from the right-hand side"

    # Log a warning if an exclusion rule is unused.
    warn-unused: true

  default: none
  enable: # please keep this alphabetized
    - depguard
    - forbidigo
    - ginkgolinter
    - gocritic
    - govet
    - ineffassign
    - logcheck
    - revive
    - staticcheck
    - testifylint
    - unused

  settings: # please keep this alphabetized
    custom:
      logcheck:
        # Installed there by hack/verify-golangci-lint.sh.
        path: ../_output/local/bin/logcheck.so
        description: structured logging checker
        original-url: k8s.io/logtools/logcheck
        settings:
          config: |
            # hack/logcheck.conf contains regular expressions that are matched against <pkg>/<file>,
            # for example k8s.io/cmd/kube-scheduler/app/config/config.go.
            #
            # By default, structured logging call parameters are checked, but usage of
            # those calls is not required. That is changed on a per-file basis.
            #
            # Remember to clean the golangci-lint cache when changing the configuration and
            # running the verify-golangci-lint.sh script multiple times, otherwise
            # golangci-lint will report stale results:
            #    _output/local/bin/golangci-lint cache clean
            
            # At this point we don't enforce the usage structured logging calls except in
            # those packages that were migrated. This disables the check for other files.
            -structured .*
            
            # Now enable it again for migrated packages.
            structured k8s.io/kubernetes/cmd/kubelet/.*
            structured k8s.io/kubernetes/pkg/kubelet/.*
            structured k8s.io/kubernetes/pkg/proxy/.*
            structured k8s.io/kms/.*
            structured k8s.io/apiserver/pkg/storage/value/.*
            structured k8s.io/apiserver/pkg/server/options/encryptionconfig/.*
            
            # The following packages have been migrated to contextual logging.
            # Packages matched here do not have to be listed above because
            # "contextual" implies "structured".
            contextual k8s.io/api/.*
            contextual k8s.io/apimachinery/pkg/util/runtime/.*
            contextual k8s.io/client-go/metadata/.*
            contextual k8s.io/client-go/rest/.*
            contextual k8s.io/client-go/tools/cache/.*
            contextual k8s.io/client-go/tools/events/.*
            contextual k8s.io/client-go/tools/record/.*
            contextual k8s.io/component-helpers/.*
            contextual k8s.io/cri-api/.*
            contextual k8s.io/cri-client/.*
            contextual k8s.io/csi-translation-lib/.*
            contextual k8s.io/dynamic-resource-allocation/.*
            contextual k8s.io/endpointslice/.*
            contextual k8s.io/kms/.*
            contextual k8s.io/kube-controller-manager/.*
            contextual k8s.io/kube-proxy/.*
            contextual k8s.io/kube-scheduler/.*
            contextual k8s.io/sample-apiserver/.*
            contextual k8s.io/sample-cli-plugin/.*
            contextual k8s.io/sample-controller/.*
            contextual k8s.io/kubernetes/cmd/kube-proxy/.*
            contextual k8s.io/kubernetes/cmd/kube-scheduler/.*
            contextual k8s.io/kubernetes/pkg/controller/.*
            contextual k8s.io/kubernetes/pkg/scheduler/.*
            contextual k8s.io/kubernetes/test/e2e/dra/.*
            contextual k8s.io/kubernetes/pkg/kubelet/cm/dra/.*
            contextual k8s.io/kubernetes/pkg/kubelet/pleg/.*
            contextual k8s.io/kubernetes/pkg/kubelet/clustertrustbundle/.*
            contextual k8s.io/kubernetes/pkg/kubelet/token/.*
            contextual k8s.io/kubernetes/pkg/kubelet/cadvisor/.*
            contextual k8s.io/kubernetes/pkg/kubelet/oom/.*
            contextual k8s.io/kubernetes/pkg/kubelet/status/.*
            contextual k8s.io/kubernetes/pkg/kubelet/sysctl/.*
            
            # As long as contextual logging is alpha or beta, all WithName, WithValues,
            # NewContext calls have to go through klog. Once it is GA, we can lift
            # this restriction. Whether we then do a global search/replace remains
            # to be decided.
            with-helpers .*
    depguard:
      rules:
        main:
          files:
            - $all
            - "!$test"
            - "!**/test/**"
          deny:
            - pkg: "github.com/google/go-cmp/cmp"
              desc: "cmp is allowed only in test files"
    forbidigo:
      analyze-types: true
      forbid:
        - pattern: ^managedfields\.ExtractInto$
          pkg: ^k8s\.io/apimachinery/pkg/util/managedfields$
          msg: should not be used because managedFields was removed
        - pattern: \.Extract
          pkg: ^k8s\.io/client-go/applyconfigurations/
          msg: should not be used because managedFields was removed
        - pattern: \.Add$
          pkg: ^k8s\.io/component-base/featuregate$         
          msg: should not use Add, use AddVersioned instead
    gocritic:	
      enabled-checks:	
        - equalFold	
        - boolExprSimplify
    revive:
      # Only these rules are enabled.
      rules:
        - name: exported
          arguments:
            - disableStutteringCheck
    staticcheck:
      checks:
        - "all"
        - "-QF1001"  # TODO(fix) Apply De Morgan’s law
        - "-QF1002"  # TODO(fix) Convert untagged switch to tagged switch
        - "-QF1003"  # TODO(fix) Convert if/else-if chain to tagged switch
        - "-QF1004"  # TODO(fix) Use strings.ReplaceAll instead of strings.Replace with n == -1
        - "-QF1006"  # TODO(fix) Lift if+break into loop condition
        - "-QF1007"  # TODO(fix) Merge conditional assignment into variable declaration
        - "-QF1008"  # TODO(fix) Omit embedded fields from selector expression
        - "-QF1009"  # TODO(fix) Use time.Time.Equal instead of == operator
        - "-QF1011"  # TODO(fix) Omit redundant type from variable declaration
        - "-QF1012"  # TODO(fix) Use fmt.Fprintf(x, ...) instead of x.Write(fmt.Sprintf(...))
        - "-S1000"   # TODO(fix) Use plain channel send or receive instead of single-case select
        - "-S1002"   # TODO(fix) Omit comparison with boolean constant
        - "-S1003"   # TODO(fix) Replace call to strings.Index with strings.Contains
        - "-S1004"   # TODO(fix) Replace call to bytes.Compare with bytes.Equal
        - "-S1005"   # TODO(fix) Drop unnecessary use of the blank identifier
        - "-S1006"   # TODO(fix) Use for { ... } for infinite loops
        - "-S1007"   # TODO(fix) Simplify regular expression by using raw string literal
        - "-S1008"   # TODO(fix) Simplify returning boolean expression
        - "-S1009"   # TODO(fix) Omit redundant nil check on slices, maps, and channels
        - "-S1011"   # TODO(fix) Use a single append to concatenate two slices
        - "-S1012"   # TODO(fix) Replace time.Now().Sub(x) with time.Since(x)
        - "-S1016"   # TODO(fix) Use a type conversion instead of manually copying struct fields
        - "-S1017"   # TODO(fix) Replace manual trimming with strings.TrimPrefix
        - "-S1019"   # TODO(fix) Simplify make call by omitting redundant arguments
        - "-S1021"   # TODO(fix) Merge variable declaration and assignment
        - "-S1023"   # TODO(fix) Omit redundant control flow
        - "-S1024"   # TODO(fix) Replace x.Sub(time.Now()) with time.Until(x)
        - "-S1025"   # TODO(fix) Don’t use fmt.Sprintf("%s", x) unnecessarily
        - "-S1028"   # TODO(fix) Simplify error construction with fmt.Errorf
        - "-S1030"   # TODO(fix) Use bytes.Buffer.String or bytes.Buffer.Bytes
        - "-S1034"   # TODO(fix) Use result of type assertion to simplify cases
        - "-S1036"   # TODO(fix) Unnecessary guard around map access
        - "-S1038"   # TODO(fix) Unnecessarily complex way of printing formatted string
        - "-S1039"   # TODO(fix) Unnecessary use of fmt.Sprint
        - "-S1040"   # TODO(fix) Type assertion to current type
        - "-SA1006"  # TODO(fix) Printf with dynamic first argument and no further arguments
        - "-SA1019"  # TODO(fix) Using a deprecated function, variable, constant or field
        - "-SA2002"  # TODO(fix) Called testing.T.FailNow or SkipNow in a goroutine, which isn’t allowed
        - "-SA4006"  # TODO(fix) A value assigned to a variable is never read before being overwritten. Forgotten error check or dead code?
        - "-ST1000"  # TODO(fix) Incorrect or missing package comment
        - "-ST1001"  # TODO(fix) Dot imports are discouraged
        - "-ST1003"  # TODO(fix) Poorly chosen identifier
        - "-ST1005"  # TODO(fix) Incorrectly formatted error string
        - "-ST1006"  # TODO(fix) Poorly chosen receiver name
        - "-ST1008"  # TODO(fix) A function’s error value should be its last return value
        - "-ST1011"  # TODO(fix) Poorly chosen name for variable of type time.Duration
        - "-ST1012"  # TODO(fix) Poorly chosen name for error variable
        - "-ST1013"  # TODO(fix) Should use constants for HTTP error codes, not magic numbers
        - "-ST1016"  # TODO(fix) Use consistent method receiver names
        - "-ST1017"  # TODO(fix) Don’t use Yoda conditions
        - "-ST1020"  # TODO(fix) The documentation of an exported function should start with the function’s name
        - "-ST1023"  # TODO(fix) Redundant type in variable declaration
    testifylint:
      enable-all: true
      disable:  # TODO: remove each disabled rule and fix it
        - empty
        - encoded-compare
        - equal-values
        - error-nil
        - expected-actual
        - float-compare
        - formatter
        - len
        - useless-assert
        - require-error
